---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);

  // Collect all unique tags
  const tagMap = new Map();
  for (const post of posts) {
    for (const tag of post.data.tags) {
      if (!tagMap.has(tag)) tagMap.set(tag, []);
      tagMap.get(tag).push(post);
    }
  }

  return Array.from(tagMap.entries()).map(([tag, posts]) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`} description={`All posts tagged with "${tag}" on The Bitcoin Breakdown.`}>
  <section class="section-page section">
    <div class="container--wide">
      <header class="page-header reveal">
        <h1>#{tag}</h1>
        <p class="section-desc">{posts.length} {posts.length === 1 ? 'post' : 'posts'} tagged with "{tag}"</p>
      </header>

      <div class="card-grid stagger">
        {posts.map((post) => (
          <div class="reveal">
            <PostCard
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              slug={post.id}
              tags={post.data.tags}
              image={post.data.image}
            />
          </div>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .page-header {
    margin-bottom: var(--space-6);
  }

  .page-header h1 {
    margin-bottom: var(--space-3);
    color: var(--gold);
  }
</style>
